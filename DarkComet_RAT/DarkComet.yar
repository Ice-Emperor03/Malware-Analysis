rule DARKCOMET_FEATURES{
    meta:
        description = "DarkComet" 
        author = "Ice Emperor"
        date = "2024-07-14"
        maltype = "Remote Access Trojan"
        filetype = "exe"
        
    strings:
        $bot1 = /(#)BOT#OpenUrl/ ascii nocase  
        $bot2 = /(#)BOT#Ping/ ascii nocase  
        $bot3 = /(#)BOT#RunPrompt/ ascii nocase
        $bot4 = /(#)BOT#SvrUninstall/ ascii nocase  
        $bot5 = /(#)BOT#URLDownload/ ascii nocase  
        $bot6 = /(#)BOT#URLUpdate/ ascii nocase 
        $bot7 = /(#)BOT#VisitUrl/ ascii nocase  
        $bot8 = /(#)BOT#CloseServer/ ascii nocase 

        $ddos1 = /(D)DOSHTTPFLOOD/ ascii nocase 
        $ddos2 = /(D)DOSSYNFLOOD/ ascii nocase 
        $ddos3 = /(D)DOSUDPFLOOD/ ascii nocase 

        $keylogger1 = /(A)ctiveOnlineKeylogger/ ascii nocase 
        $keylogger2 = /(U)nActiveOnlineKeylogger/ ascii nocase 
        $keylogger3 = /(A)ctiveOfflineKeylogger/ ascii nocase 
        $keylogger4 = /(U)nActiveOfflineKeylogger/ ascii nocase 

        $shell1 = /(A)CTIVEREMOTESHELL/ ascii nocase 
        $shell2 = /(S)UBMREMOTESHELL/ ascii nocase 
        $shell3 = /(K)ILLREMOTESHELL/ ascii nocase 

    condition:
        4 of ($bot*) or all of ($ddos*) or all of ($keylogger*) or all of ($shell*)
}
rule DARKCOMET_STRINGS{
    meta:
        description = "DarkComet" 
        author = "Ice Emperor"
        date = "2024-07-14"
        maltype = "Remote Access Trojan"
        filetype = "exe"

    strings:
        $string1 = "Command successfully executed!"
        $string2 = "NETDATA" nocase
        $string3 = "%s, ClassID: %s"
        $string4 = "I wasn't able to open the hosts file"
        $string5 = "#KCMDDC"
        $string6 = "FastMM Borland Edition"
        $a1 = "WEBCAMSTOP"
        $a2 = "#SendTaskMgr"
        $a3 = "#RemoteScreenSize"
        $a4 = "ping 127.0.0.1 -n 4 > NUL &&"
	$a5 = "MSRSAAP.EXE"
    condition:
        any of ($string*) and 2 of ($a*)
}
rule DARKCOMET_MUTEX {
    meta:
        description = "DarkComet"
        author = "Ice Emperor"
        date = "2024-07-14"
        maltype = "Remote Access Trojan"
        filetype = "exe"
       /*
        Dark Comet has a default MUTEX of DC_MUTEX-7 random Alphanumeric characters
        I added a wildcard to detect variants in case it changes
      */
    strings:
        $MUTEX_original = /DC_MUTEX-[0-9A-Z]{7}/
        $MUTEX_variant = /DC_MUTEX-\w*/
    
    condition:
        $MUTEX_original or $MUTEX_variant
}
rule DARKCOMET_DIRECTORY{
    meta:
        description = "DarkComet"
        author = "Ice Emperor"
        date = "2024-07-14"
        maltype = "Remote Access Trojan"
        filetype = "exe"
    strings:
      /*
        Dark Comet creates the MSDCSC directory, which is a common path utilized by it.
        The hex when translated to text: MSDCSC\xxxx.exe, I replaced xxxx with a YARA 
        wildard just in case the name of the executable changes. (Deafult: msdcsc.exe) 
      */
	$original = {4D 53 44 43 53 43 5C 6D 73 64 63 73 63 2E 65 78 65}
        $improv = {4D 53 44 43 53 43 5C [-] 2E 65 78 65}
    condition:
        $original or $improv
}
rule DARKCOMET_POST_REQUEST {
    meta:
        description = "DarkComet"
        author = "Ice Emperor"
        date = "2024-07-14"
        maltype = "Remote Access Trojan"
        filetype = "exe"
    strings:
	$original = {50 4F 53 54 20 2F 69 6E 64 65 78 2E 70 68 70 2F 31 2E 30}
	$improv = {50 4F 53 54 20 2F [-] 2E 70 68 70 [-] 2E [-] 0D 0A}
    condition:
        $original or $improv
}
